<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Optana â€“ Family Groups</title>
  <meta name="description" content="Manage your family groups"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <style>
    :root {
      --primary-color: #FF8C42;
      --accent-light: #FFBC80;
      --dark: #333333;
      --light: #FFFFFF;
      --gray-light: #F5F5F5;
      --gray: #E0E0E0;
      --sidebar-width: 260px;
      --danger: #dc3545;
    }
    body { font-family:'Playfair Display',serif; color:var(--dark); background:var(--gray-light); display:flex; min-height:100vh; }
    .mono { font-family:'Roboto Mono', monospace; }
    .sidebar { width:var(--sidebar-width); background:var(--dark); color:var(--light); position:fixed; top:0; left:0; height:100vh; display:flex; flex-direction:column; }
    .sidebar-header { padding:1.5rem; border-bottom:1px solid rgba(255,255,255,0.1); }
    .logo { font-size:1.8rem; text-align:center; font-weight:700; }
    .logo span { color:var(--primary-color); }
    .logo a { text-decoration: none; color: var(--light);}
    .user-profile { padding: 1.5rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .user-avatar { width: 80px; height: 80px; border-radius: 50%; background: var(--primary-color); margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: var(--light);}
    .user-info h3 { font-size: 1.2rem; margin-bottom: 0.5rem; }
    .user-email { font-family: 'Roboto Mono', monospace; font-size: 0.8rem; color: rgba(255,255,255,0.7); }
    .nav-menu { padding: 1.5rem 0; flex-grow: 1; }
    .nav-item { list-style: none; }
    .nav-link { display: flex; align-items: center; padding: 0.8rem 1.5rem; color: var(--gray); text-decoration: none; transition: all 0.3s; font-family: 'Roboto Mono', monospace; font-size: 0.95rem; }
    .nav-link:hover { background: rgba(255,255,255,0.1); color: var(--light); }
    .nav-link.active { background: var(--primary-color); color: var(--light); }
    .nav-link i { margin-right: 1.5rem; width: 20px; text-align: center; }
    .sidebar-footer { padding: 1rem 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); }
    .btn { font-family:'Roboto Mono', monospace; cursor:pointer; border:none; border-radius:8px; padding:0.5rem 1rem; }
    .btn-primary { background:var(--primary-color); color:var(--light); }
    .btn-primary:hover { background:var(--accent-light); }
    .btn-secondary { background:var(--gray); color:var(--dark); }
    .btn-secondary:hover { background: #d0d0d0; }
    .main-content { margin-left:var(--sidebar-width); flex:1; padding:2rem; }
    .frame { background: var(--light); border-radius: 16px; padding: 2rem; box-shadow: 0 8px 24px rgba(0,0,0,0.1); margin: 0 auto; max-width: 1000px; }
    .page-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem; }
    .page-title { font-size:2rem; }
    .group-actions { display: flex; gap: 1rem; margin-bottom: 2rem;}
    .groups-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 1.5rem; }
    .card { background:var(--light); border-radius:12px; padding:1.5rem; box-shadow:0 4px 12px rgba(0,0,0,0.05); display:flex; flex-direction:column; }
    .card h3 { margin-bottom:0.5rem; font-size:1.25rem; }
    .card .meta { font-family:'Roboto Mono', monospace; font-size:0.8rem; color:#777; margin-bottom:1rem; }
    .alert { padding:1rem; border-radius:8px; margin-bottom:1.5rem; display:none; }
    .alert-danger { background:#f8d7da; color:#721c24; }
    .alert-info { background: #e3f2fd; color: #0d47a1;}
    /* Modal Styles */
    .modal-bg {
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;
    }
    .modal-bg.active { display: flex; }
    .modal {
      background: var(--light); border-radius: 14px; max-width: 340px; width: 100%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.18); padding: 2rem 1.5rem 1.5rem 1.5rem; position: relative;
      animation: popin 0.2s;
    }
    @keyframes popin { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .modal-close { position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 1.3rem; color: #888; cursor: pointer; }
    .modal-title { font-size: 1.2rem; margin-bottom: 1rem; }
    .modal-form-group { margin-bottom: 1rem; }
    .modal-label { display: block; margin-bottom: 0.5rem; font-family: 'Roboto Mono', monospace; font-size: 0.95rem; }
    .modal-input {
      width: 100%; padding: 0.7rem 1rem; border-radius: 8px; border: 1px solid var(--gray);
      font-size: 1rem; font-family: 'Roboto Mono', monospace;
    }
    .modal-actions { display: flex; gap: 1rem; justify-content: flex-end; }
    .modal-error { color: var(--danger); font-size: 0.95rem; margin-bottom: 0.5rem; }
    @media (max-width: 992px) { .main-content { margin-left: 80px; } }
    @media (max-width: 600px) { .sidebar { width: 100vw; position: static; height: auto; } .main-content { margin-left: 0; padding: 1rem; } .frame { padding: 1rem; } }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo"><a href="index.html">Opt<span>ana</span></a></div>
    </div>
    <div class="user-profile">
      <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
      <div class="user-info">
        <h3 id="profileUsername">User</h3>
        <div class="user-email" id="profileEmail">user@example.com</div>
      </div>
    </div>
    <nav class="nav-menu" aria-label="Main Navigation">
      <ul>
        <li class="nav-item"><a href="dashboard.html" class="nav-link"><i class="fas fa-home"></i><span>Dashboard</span></a></li>
        <li class="nav-item"><a href="my-wishlists.html" class="nav-link"><i class="fas fa-gift"></i><span>My Wishlists</span></a></li>
        <li class="nav-item"><a href="friend-groups.html" class="nav-link"><i class="fas fa-users"></i><span>Friend Groups</span></a></li>
        <li class="nav-item"><a href="family-groups.html" class="nav-link active"><i class="fas fa-house-user"></i><span>Family Groups</span></a></li>
        <li class="nav-item"><a href="browse.html" class="nav-link"><i class="fas fa-search"></i><span>Browse</span></a></li>
        <li class="nav-item"><a href="favorites.html" class="nav-link"><i class="fas fa-heart"></i><span>Favorites</span></a></li>
        <li class="nav-item"><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i><span>Settings</span></a></li>
        <li class="nav-item"><a href="about.html" class="nav-link"><i class="fas fa-info-circle"></i><span>About</span></a></li>
      </ul>
    </nav>
    <div class="sidebar-footer">
      <button id="logoutBtn" class="btn btn-primary"><i class="fas fa-sign-out-alt"></i> Log Out</button>
    </div>
  </aside>
  <main class="main-content">
    <div class="frame">
      <div class="page-header">
        <h1 class="page-title">Family Groups</h1>
      </div>
      <div class="group-actions">
        <a class="btn btn-primary" href="create-family-group.html">Create Group</a>
        <button class="btn btn-secondary" onclick="showModal('code')">Join by Code</button>
        <button class="btn btn-secondary" onclick="showModal('link')">Join by Invite Link</button>
      </div>
      <div id="errorAlert" class="alert alert-danger"></div>
      <div id="infoAlert" class="alert alert-info" style="display:none;"></div>
      <div id="groupsList" class="groups-list"></div>
    </div>
    <!-- Modal for join by code/link -->
    <div class="modal-bg" id="joinModalBg">
      <div class="modal" id="joinModal">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-title" id="modalTitle">Join Group</div>
        <form id="joinForm" onsubmit="return false;">
          <div class="modal-form-group">
            <label class="modal-label" id="modalLabel" for="modalInput">Group Code</label>
            <input class="modal-input" id="modalInput" type="text" autocomplete="off" required>
          </div>
          <div class="modal-error" id="modalError" style="display:none;"></div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Join</button>
          </div>
        </form>
      </div>
    </div>
  </main>
  <script>
    // Firebase config & initialization
    const firebaseConfig = {
      apiKey: "AIzaSyA_CZn_fLuzyBoWCqKxI0SHPalTGBaLIGc",
      authDomain: "optanav1.firebaseapp.com",
      projectId: "optanav1",
      storageBucket: "optanav1.appspot.com",
      messagingSenderId: "16298669202",
      appId: "1:16298669202:web:ac2a1cd399993b1883624b",
      measurementId: "G-RR7D4MB5FY"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM references
    const logoutBtn = document.getElementById('logoutBtn');
    const errorAlert = document.getElementById('errorAlert');
    const infoAlert = document.getElementById('infoAlert');
    const groupsList = document.getElementById('groupsList');
    const profileUsername = document.getElementById('profileUsername');
    const profileEmail = document.getElementById('profileEmail');
    const userAvatar = document.getElementById('userAvatar');
    let currentUser = null;

    // Modal references
    const joinModalBg = document.getElementById('joinModalBg');
    const joinModal = document.getElementById('joinModal');
    const joinForm = document.getElementById('joinForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalLabel = document.getElementById('modalLabel');
    const modalInput = document.getElementById('modalInput');
    const modalError = document.getElementById('modalError');
    let joinMode = "code"; // or "link"

    // Show user info and load groups
    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      currentUser = user;
      profileUsername.textContent = user.displayName || "User";
      profileEmail.textContent = user.email;
      if (user.photoURL) {
        userAvatar.innerHTML = `<img src="${user.photoURL}" style="width:100%;height:100%;border-radius:50%;">`;
      }
      loadGroups();
    });

    logoutBtn.addEventListener('click', () => {
      auth.signOut().then(() => window.location.href = "login.html");
    });

    async function loadGroups() {
      errorAlert.style.display = 'none';
      infoAlert.style.display = 'block';
      infoAlert.textContent = "Loading your family groups...";
      groupsList.innerHTML = '';
      try {
        const snap = await db.collection('familyGroups').where('members', 'array-contains', currentUser.uid).get();
        infoAlert.style.display = 'none';
        if (snap.empty) {
          groupsList.innerHTML = '<p style="grid-column:1/-1;color:#777;text-align:center;">You are not in any family groups yet.</p>';
          return;
        }
        snap.forEach(doc => {
          const group = doc.data();
          groupsList.innerHTML += `
            <div class="card">
              <h3>${group.name || "Unnamed Group"}</h3>
              <div class="meta">Members: ${group.members ? group.members.length : 0}</div>
              <div class="meta">Group ID: <span class="mono">${doc.id}</span></div>
            </div>
          `;
        });
      } catch (err) {
        infoAlert.style.display = 'none';
        errorAlert.textContent = 'Failed to load your family groups.';
        errorAlert.style.display = 'block';
      }
    }

    // Modal logic
    function showModal(mode) {
      joinMode = mode;
      modalError.style.display = "none";
      modalInput.value = "";
      if (mode === "code") {
        modalTitle.textContent = "Join Group by Code";
        modalLabel.textContent = "Group Code";
        modalInput.placeholder = "Paste group code here";
      } else {
        modalTitle.textContent = "Join Group by Invite Link";
        modalLabel.textContent = "Invite Link";
        modalInput.placeholder = "Paste invite link here";
      }
      joinModalBg.classList.add("active");
      setTimeout(() => modalInput.focus(), 100);
    }
    function closeModal() {
      joinModalBg.classList.remove("active");
      modalError.style.display = "none";
      modalInput.value = "";
    }
    joinModalBg.addEventListener('click', function(e) {
      if (e.target === joinModalBg) closeModal();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === "Escape") closeModal();
    });

    joinForm.onsubmit = async function(e) {
      e.preventDefault();
      modalError.style.display = "none";
      const value = modalInput.value.trim();
      if (!value) {
        modalError.textContent = "Please enter a value.";
        modalError.style.display = "block";
        return;
      }
      let groupId;
      if (joinMode === "code") {
        groupId = value;
      } else {
        // Try to extract group id from ?group=GROUPID
        const match = value.match(/[?&]group=([\w-]+)/);
        if (!match) {
          modalError.textContent = "Invalid invite link.";
          modalError.style.display = "block";
          return;
        }
        groupId = match[1];
      }
      try {
        const docRef = db.collection('familyGroups').doc(groupId);
        const doc = await docRef.get();
        if (!doc.exists) {
          modalError.textContent = "No group found with that code/link.";
          modalError.style.display = "block";
          return;
        }
        const members = doc.data().members || [];
        if (!members.includes(currentUser.uid)) {
          await docRef.update({ members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
          closeModal();
          loadGroups();
        } else {
          modalError.textContent = "You are already a member of this group.";
          modalError.style.display = "block";
        }
      } catch (err) {
        modalError.textContent = "Failed to join group.";
        modalError.style.display = "block";
      }
    };
  </script>
</body>
</html>
